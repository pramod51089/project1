ARG JENKINS_IMAGE
FROM $JENKINS_IMAGE

RUN mkdir -p /var/www/html
ADD build.tar.gz /var/www/html/
RUN chown -R magento:magento /var/www/html/

RUN ln -s /config/cron-newrelic.ini /etc/opt/remi/php82/php.d/newrelic.ini

RUN yum update -y \
    && yum install crontabs -y

COPY docker/cron/php/conf/magento-cron /var/spool/cron/magento
RUN chown magento:magento /var/spool/cron/magento
COPY docker/cron/php/conf/set_env.sh /tmp/set_env.sh
RUN chown root:root /tmp/set_env.sh
RUN chmod 777 /tmp/set_env.sh

ENTRYPOINT ["/bin/bash", "-c"]
CMD ["/tmp/set_env.sh && /usr/bin/php -d memory_limit=2G /var/www/html/bin/magento setup:upgrade --keep-generated --no-interaction && postfix start && /usr/sbin/crond -x sch && /var/www/html/bin/magento cache:clean && /var/www/html/bin/magento cache:flush"]
